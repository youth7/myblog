# 1 概念

# 2 分布式系统原理

## 2.1 数据分布方式

### 2.1.1 哈希方式

### 2.1.2 按数据范围

### 2.1.3 按数据量

### 2.1.4 一致性哈希

### 2.1.5 副本与数据分布

**基本策略**：以机器为单位，若干机器互为副本，副本机器之间的数据完全相同

* 优点：简单
* 缺点：
    * 首先、使用该方式时，一旦出现副本数据丢失，需要恢复副本数据时效率不高
    * 再者、该种方式不利于提高系统扩展性
    * 最后、这种方式不利于系统容错

**优化策略**：数据段为单位作为副本

## 2.2 基本副本协议

## 2.2.2 primary-secondary协议

这里需要注意，从2.1.5中我们得知，primary是一个逻辑实体，**它的数据不一定全部都在一台机器上，可能分布在多台机器上**，同样的概念也适用于secondary。

primary节点需要负责维护数据的**更新、并发控制、协调副本的一致性**，因此一致性是一个由始至终都影响着分布式协议的重要因素。  

primary-secondary协议需要解决的4大问题，总结来说就是数据的读/写/同步和副本的主副切换。

* **问题一：数据更新流程**
    * 第1步：数据更新都由primary节点协调完成（严格来说这点不能算步骤，只能说是约束或者原则）
    * 第2步：外部节点将更新操作发给primary节点。
    * 第3步：primary节点进行并发控制即确定并发更新操作的先后顺序，因为是中心化的副本协议，自然由primary节点进行控制。
    * 第4步：primary节点将更新操作发送给secondary节点。这是最为关键的地方，因为网络通讯的问题，很有可能secondary会收不到通知，因此如何进行异常处理就是最为重要的事情。“Quorum副本控制机制”是处理这种问题一种重要的手段。
    * 第5步：primary根据secondary节点的完成情况决定更新是否成功并将结果返回外部节点。这步具体如何处理依赖于上一步
* **问题二：数据读取方式**
* **问题三：Primary副本的确定和切换**
* **问题四：数据同步（reconcile）**

## 2.2.3 去中心化副本控制协议