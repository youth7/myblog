# 00 å¼€ç¯‡è¯

## å€¼æ”¾å †ä¸Šè¿˜æ˜¯æ ˆä¸Š

* **å­¦ä¹ éš¾ç‚¹**ï¼šç±»å‹ç³»ç»Ÿã€æ³›å‹ã€å¹¶å‘å®‰å…¨

* **å­¦ä¹ æ ¸å¿ƒ**ï¼šè½¯ä»¶å¼€å‘çš„æ ¸å¿ƒæ¦‚å¿µï¼ˆåŒ…æ‹¬ï¼šå †ã€æ ˆã€å‡½æ•°ã€é—­åŒ…ã€è™šè¡¨ã€æ³›å‹ã€åŒæ­¥å’Œå¼‚æ­¥ç­‰ ï¼‰ ï¼Œ**ç¼–ç¨‹è¯­è¨€ä¸è¿‡æ˜¯è½¯ä»¶å¼€å‘æ ¸å¿ƒæ¦‚å¿µçš„å…·ä½“è¡¨è¿°å’Œè½½ä½“**



## åŸºæœ¬æ¦‚å¿µ

**æ•°æ®ï¼š**

åŸç”Ÿç±»å‹ï¼ˆprimitive typeï¼‰ï¼šæ‰€æœ‰åŸç”Ÿç±»å‹è§[è¿™é‡Œ](https://doc.rust-lang.org/stable/std/index.html#primitives)ï¼ŒRustçš„åŸç”Ÿç±»å‹æ¯”Cè¯­è¨€ä¸°å¯Œå¤ªå¤šï¼Œä¾‹å¦‚ä»¥ä¸‹å‡ ç§ç±»å‹å±…ç„¶ä¹Ÿæ˜¯åŸç”Ÿçš„ï¼š

- [array](https://doc.rust-lang.org/stable/std/primitive.array.html)
- [fn](https://doc.rust-lang.org/stable/std/primitive.fn.html)
- [pointer](https://doc.rust-lang.org/stable/std/primitive.pointer.html)
- [reference](https://doc.rust-lang.org/stable/std/primitive.reference.html)
- [str](https://doc.rust-lang.org/stable/std/primitive.str.html)
- [tuple](https://doc.rust-lang.org/stable/std/primitive.tuple.html)

éœ€è¦æ³¨æ„`reference`å’Œ`pointer`çš„åŒºåˆ«ï¼Œ`reference`æ¯”`pointer`æºå¸¦äº†æ›´åŠ å¤šçš„ä¿¡æ¯ï¼ˆä¾‹å¦‚èƒ–æŒ‡é’ˆï¼‰ï¼Œæ›´åŠ å®‰å…¨ï¼ˆä¸èƒ½æŒ‡å‘nullï¼‰ï¼Œä½†ä¹Ÿå—åˆ°ä¸€äº›é™åˆ¶ï¼ˆåªèƒ½è§£å¼•ç”¨ä¸ºåŸæ¥çš„æ•°æ®ç±»å‹ï¼‰ã€‚



# 01 å‰ç½®ç¯‡

* stackä¸Šçš„æ•°æ®ï¼šæ˜¯é™æ€çš„ï¼ŒæŒ‡**é™æ€å¤§å°**ï¼ˆç¼–è¯‘å™¨å°±èƒ½ç¡®å®šæ•°æ®çš„å¤§å°ï¼‰ï¼Œ**é™æ€ç”Ÿå‘½å‘¨æœŸ**ï¼ˆä¸æ ˆçš„ç”Ÿå‘½å‘¨æœŸä¸€è‡´ï¼‰ã€‚å…¶å®è¿™ä¹Ÿä¸æ˜¯ç»å¯¹çš„ï¼Œ**ä¾‹å¦‚`alloca()`å°±å¯ä»¥åŠ¨æ€åœ°åœ¨æ ˆä¸Šåˆ†é…å†…å­˜**ï¼ŒCè¯­è¨€ä¸­çš„å¯å˜å‚ä¹Ÿæ˜¯åˆ†é…åœ¨æ ˆä¸Šçš„ã€‚ä½†å› ä¸ºstackæ˜¯è¾ƒå°ä¸”æœ‰é™çš„ï¼Œåœ¨ä¸Šé¢åŠ¨æ€åˆ†é…ç©ºé—´å®¹æ˜“å¯¼è‡´æº¢å‡ºç±»é—®é¢˜ã€‚
* heapä¸Šçš„æ•°æ®ï¼šæ˜¯åŠ¨æ€çš„ï¼ŒæŒ‡åŠ¨æ€å¤§å°ï¼ˆè¿è¡ŒæœŸé—´å¤§å°å¯èƒ½ä¼šæ”¹å˜ï¼‰ï¼ŒåŠ¨æ€ç”Ÿå‘½å‘¨æœŸï¼ˆå¯èƒ½ä¼šè¢«å¤šä¸ªæ ˆå¼•ç”¨ï¼‰

# 02 åŸºç¡€ç¯‡

## æ‰€æœ‰æƒ

1. å…³äºæ‰€æœ‰æƒçš„ä¸€äº›è¦ç‚¹ï¼š

   * **åˆ†æ¸…æ¥šowner/value/reference/borrowï¼Œè§ä¸‹é¢*å€¼çš„åˆ›å»º*ç›¸å…³è®¨è®ºï¼Œè¿™æ˜¯é‡ä¸­ä¹‹é‡**

   * è¦æ³¨æ„åŒºåˆ†å¼•ç”¨å’Œå€Ÿç”¨çš„å…³ç³»ï¼Œå®˜æ–¹æ–‡æ¡£ä¸­æœ‰ï¼š

     > We call the action of creating a reference *borrowing*

   * Rustå‡½æ•°è°ƒç”¨çš„æ—¶å€™**æ‰€æœ‰æƒä¼šè½¬ç§»ï¼Œä¾‹å¦‚`func(var)`å¹¶ä¸ä¼šè‡ªåŠ¨è‡ªåŠ¨è½¬ä¸º`func(&var)`å¹¶é€ æˆæ‰€æœ‰æƒè½¬ç§»**ã€‚



2. é€šè¿‡æ‰€æœ‰æ‰€æœ‰æƒæœºåˆ¶è¿›è¡Œå†…å­˜ç®¡ç†ï¼Œè§£å†³äº†ä»¥ä¸‹é—®é¢˜ï¼š

   * èµ„æºè‡ªåŠ¨é‡Šæ”¾ï¼Œ**å®ƒä½¿å¾—åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå †ä¸Šå’Œæ ˆä¸Šæ•°æ®çš„ç”Ÿå‘½å‘¨æœŸä¸€è‡´äº†**

   * é˜²æ­¢æ•°æ®è¢«æ„å¤–ä¿®æ”¹ï¼ŒåŒä¸€æ—¶åˆ»ï¼Œä¸€ä¸ªå€¼åªæœ‰1ä¸ªå¯å˜å¼•ç”¨æˆ–è€…å¤šä¸ªä¸å¯å˜å¼•ç”¨

    > æ‰€æœ‰æƒè§„åˆ™ï¼ˆç¼–è¯‘æ—¶æ£€æŸ¥ï¼‰ï¼š
    >
    > - Each value in Rust has an *owner*.
    > - There can only be one owner at a time.
    > - When the owner goes out of scope, the value will be dropped.



3. `Rc/Arc`æä¾›äº†**å…±äº«æ‰€æœ‰æƒ**ï¼ˆæ‰€æœ‰æƒè§„åˆ™çš„ä¸€ä¸ªä¾‹å¤–ï¼Ÿï¼‰ï¼Œ`Cell/RefCell`æä¾›äº†**å†…éƒ¨å¯å˜æ€§**ã€‚è¿™æ„å‘³ç€é™¤äº†`Rc/Arc`ï¼Œå…¶å®ƒæ ‡å‡†åº“çš„æ•°æ®å¯¹è±¡éƒ½æ»¡è¶³æ‰€æœ‰æƒè§„åˆ™ã€‚

   |            | è¯­æ³•                | æ‰€æœ‰æƒæ£€æŸ¥ï¼ˆ3æ¡è§„åˆ™ï¼‰  |
   | ---------- | ------------------- | ---------------------- |
   | å¤–éƒ¨å¯å˜æ€§ | `let mut`æˆ–è€…`&mut` | ç¼–è¯‘æ—¶æ£€æŸ¥ï¼ˆé™æ€æ£€æŸ¥ï¼‰ |
   | å†…éƒ¨å¯å˜æ€§ | ä½¿ç”¨`Cell/RefCell`  | è¿è¡Œæ—¶æ£€æŸ¥ï¼ˆåŠ¨æ€æ£€æŸ¥ï¼‰ |

   



## ç”Ÿå‘½å‘¨æœŸ

* é‡è¦çš„åªæœ‰ä¸€å¥è¯ï¼š**ç”Ÿå‘½å‘¨æœŸçš„æ ‡è®°åªæ˜¯å‡½æ•°ç­¾åçš„ä¸€éƒ¨åˆ†ï¼Œå®ƒæè¿°äº†å…¥å‚å’Œè¿”å›å€¼çš„å…³ç³»ï¼Œä¸æ”¹å˜ç³»ç»Ÿä¸­ä»»ä½•å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸ**ã€‚

* ç”Ÿå‘½å‘¨æœŸçš„ä½œç”¨ï¼šé˜²æ­¢è¯»å–åˆ°å†…å­˜ä¸­çš„æ— æ•ˆå•å…ƒ

* ç”Ÿå‘½å‘¨æœŸä¸­æœ€éš¾ä»¥ç†è§£çš„ä¸€äº›è¯¯è§£
  * `T: 'static` vs `&'static T`ï¼Œå…³äºå®ƒçš„è§£é‡Šè§å‚è€ƒèµ„æ–™ã€‚ç®€å•æ¥è¯´ï¼Œå‰è€…çš„`T`**åŒ…æ‹¬äº†åè€…ï¼ˆå³`&'static T`ï¼‰å’Œæ‰€æœ‰æƒç±»å‹**ï¼Œåæ­£**ç¦æ­¢æ¶‰åŠé`'static`ç”Ÿå‘½å‘¨æœŸçš„å¼•ç”¨**ï¼Œå› ä¸ºå½“`T`ä¸ºé`'static`å¼•ç”¨çš„æ—¶å€™å¯èƒ½ä¸èƒ½æ»¡è¶³ä¸€äº›ä½¿ç”¨åœºæ™¯ï¼ˆä¾‹å¦‚è·¨çº¿ç¨‹ï¼‰ï¼Œè§å‚è€ƒ4ã€‚


![](../../imgs/rust_lifetimes.jpg)



å‚è€ƒï¼š

* [Why does the compiler tell me to consider using a `let` binding" when I already am?](https://stackoverflow.com/questions/28893183/why-does-the-compiler-tell-me-to-consider-using-a-let-binding-when-i-already)
* [Rust ä¸­å¸¸è§çš„æœ‰å…³ç”Ÿå‘½å‘¨æœŸçš„è¯¯è§£](https://github.com/pretzelhammer/rust-blog/blob/master/posts/translations/zh-hans/common-rust-lifetime-misconceptions.md)
* https://practice.rs/lifetime/static.html
* [Learning Rust: static trait bounds](https://codeandbitters.com/static-trait-bound/)

## å†…å­˜ç®¡ç†

**å€¼çš„åˆ›å»º**

* æ ˆä¸Šæ”¾èƒ–æŒ‡é’ˆï¼Œå †ä¸Šæ”¾æ•°æ®ï¼Œç»å¤§éƒ¨åˆ†çš„Rustå¯¹è±¡éƒ½æ˜¯è¿™ç§å…³ç³»çš„ã€‚èƒ–æŒ‡é’ˆå°±æ˜¯å„ç§åŸç”Ÿæˆ–è€…è‡ªå®šä¹‰çš„ç±»å‹ï¼Œä¾‹å¦‚ä»¥ä¸‹ä»£ç ï¼š

  ```rust
  let s = String::from("hi");//sçš„ç±»å‹Stringï¼Œæ˜¯ä¸€ä¸ªèƒ–æŒ‡é’ˆï¼Œåœ¨è¯­ä¹‰ä¸Šæ¥è®²æ˜¯owner
  let rs = &s;// rsçš„ç±»å‹&Stringï¼Œå®ƒæ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œåœ¨è¯­ä¹‰ä¸Šæ¥è®²æ˜¯borrow
  ```

  | å¯¹è±¡                 | è¯­ä¹‰              | ç±»å‹/åˆ†é…                                         |
  | -------------------- | ----------------- | ------------------------------------------------- |
  | `s`                  | ownerï¼Œæ‰€æœ‰æƒç±»å‹ | `String`è¿™ä¸ªç»“æ„ä½“ï¼ˆæ™ºèƒ½æŒ‡é’ˆï¼‰ï¼Œåˆ†é…åœ¨æ ˆä¸Š        |
  | `&s`                 | borrowï¼Œå¼•ç”¨ç±»å‹  | æ˜¯ä¸€ä¸ª`&String`ï¼ˆæ™®é€šå¼•ç”¨ï¼Œéèƒ–æŒ‡é’ˆï¼‰ï¼Œåˆ†é…åœ¨æ ˆä¸Š |
  | `String::from("hi")` | value             | åˆ†é…åœ¨å †ä¸Šçš„äºŒè¿›åˆ¶æ•°æ®                            |

  å…³äºèƒ–æŒ‡é’ˆå¯ä»¥å‚è€ƒ[Exploring Rust fat pointers](https://iandouglasscott.com/2018/05/28/exploring-rust-fat-pointers/)å’Œhttps://doc.rust-lang.org/book/ch15-00-smart-pointers.htmlï¼Œå…¶ä¸­å®˜æ–¹æ–‡æ¡£ä¸­æœ‰ä¸€å¥ï¼š*in many cases, smart pointers own the data they point to.*

* `Option`ã€`Result`å¯¹å¼•ç”¨ç±»æ•°æ®çš„ä¼˜åŒ–

**å€¼çš„é”€æ¯**

* `Drop` trait

* `RAII`

| æ£€æŸ¥æ—¶æœº | ç¼–è¯‘æ—¶         | è¿è¡Œæ—¶             |
| -------- | -------------- | ------------------ |
| æ£€æŸ¥æ•ˆæœ | é«˜æ•ˆã€ä½†ä¸çµæ´» | çµæ´»ã€ä½†æœ‰é¢å¤–è´Ÿæ‹… |
| æ£€æŸ¥ä½ç½® | æ ˆ             | å †                 |
| æ£€æŸ¥æœºåˆ¶ | borrow checker | å¼•ç”¨è®¡æ•°           |



## ç±»å‹ç³»ç»Ÿ

### traitçš„æ¦‚æ‹¬

traitçš„ä½œç”¨ï¼š

* è¡Œä¸ºæŠ½è±¡ï¼š
* æ³›å‹çº¦æŸï¼štrait bound
* æŠ½è±¡ç±»å‹ï¼štrait object
* æ ‡ç­¾traitï¼š

å¤šæ€ï¼šåœ¨ä½¿ç”¨ç›¸åŒçš„æ¥å£æ—¶ï¼Œä¸åŒç±»å‹çš„å¯¹è±¡ï¼Œä¼šé‡‡ç”¨ä¸åŒçš„å®ç°  

| å¤šæ€ç±»å‹              | å®ç°æŠ€æœ¯     | å¤‡æ³¨                                            |
| --------------------- | ------------ | ----------------------------------------------- |
| å‚æ•°å¤šæ€              | æ³›å‹         | åŒ…å«æ³›å‹æ•°æ®ç»“æ„å’Œæ³›å‹å‡½æ•°                      |
| adhocå¤šæ€ï¼ˆç‰¹è®¾å¤šæ€ï¼‰ | trait        | æŒ‡åŒä¸€ç§è¡Œä¸ºæœ‰å¾ˆå¤šä¸åŒçš„å®ç°ï¼ˆæ­£æ˜¯traitçš„ç”¨é€”ï¼‰ |
| å­ç±»å‹å¤šæ€            | trait object |                                                 |



### æ™®é€šæ³›å‹ã€`impl Trait` å’Œ`dyn Trait`

* traitä¸æ˜¯ç±»å‹ï¼Œç±»å‹æ˜¯å€¼çš„é›†åˆï¼Œè€Œtraitåªèƒ½ç”¨æ¥é™åˆ¶ç±»å‹ã€‚ä¾‹å¦‚æˆ‘ä»¬ä¸èƒ½å†™`x: Trait`è€Œåªèƒ½`<X: Trait>`ï¼Œåœ¨åè€…ä¸­`Trait`å¯¹ç±»å‹`X`åšäº†ä¸€äº›é™å®šï¼Œä½†**`Trait`å¹¶ä¸æ˜¯ç±»å‹**ã€‚è¿™ç§æ–¹å¼å’Œ`impl Trait`å®¹æ˜“ä»¤äººäº§ç”Ÿtraitæ˜¯ç±»å‹çš„é”™è§‰ã€‚
* `impl Trait`å’Œæ™®é€šæ³›å‹`<X: Trait>`åŸºæœ¬ä¸€æ ·ï¼Œéƒ½å¯ç”¨äºå‡½æ•°çš„å‚æ•°/è¿”å›å€¼ã€‚ä½†ç”¨äºè¿”å›å€¼æ—¶æœ‰ç»†å¾®åŒºåˆ«ï¼š
  * `<X: Trait>`çš„**è¿”å›å€¼æ˜¯æ³›å‹**ã€‚calleråœ¨è°ƒç”¨çš„æ—¶å€™ç¡®å®šè¿”å›å€¼çš„å…·ä½“ç±»å‹ï¼ˆè¿™ä¹Ÿç¬¦å·æ³›å‹çš„ä½¿ç”¨åœºæ™¯ï¼Œå¼€å‘è€…å®šä¹‰æ³›å‹ï¼Œè°ƒç”¨è€…ç¡®å®šæ³›å‹ï¼‰
  * `impl Trait`çš„**è¿”å›å€¼æ˜¯å…·ä½“ç±»å‹**ã€‚calleeåœ¨ç¼–è¯‘æœŸï¼ˆé€šè¿‡æ™ºèƒ½æ¨æ–­ï¼‰ç¡®å®šè¿”å›å€¼çš„å…·ä½“ç±»å‹ï¼Œä½†æ˜¯callerä¸çŸ¥é“è¿™ä¸ªç±»å‹ï¼Œ**åªçŸ¥é“è¿”å›å€¼å®ç°äº†æŸä¸ªtrait**ã€‚
  * `impl Trait`ä½œä¸ºå‡½æ•°å‚æ•°æ—¶ä¼šè¢«å•æ€åŒ–ï¼ˆå› ä¸ºæ˜¯æ³›å‹ï¼‰ï¼Œä½œä¸ºè¿”å›å€¼æ—¶ä¸éœ€è¦ï¼ˆå› ä¸ºä¸æ˜¯æ³›å‹ï¼‰ã€‚
* `impl Trait`å’Œ`<X: Trait>`ç¼–è¯‘åå•æ€åŒ–ï¼Œ`dyn Trait`ä¸éœ€è¦å•æ€åŒ–ï¼Œå› ä¸º`dyn Trait`**ä¸æ˜¯æ³›å‹è€Œæ˜¯å…·ä½“ç±»å‹**ã€‚

|                            | æ™®é€šæ³›å‹    | `impl Trait` | `dyn Trait` |
| -------------------------- | ----------- | ------------ | ----------- |
| æ˜¯å¦æ³›å‹ï¼ˆä½œä¸ºæ•°æ®ç»“æ„ï¼‰   | âœ”ï¸ï¼ˆå•æ€åŒ–ï¼‰ | ğŸš«            | âŒ           |
| æ˜¯å¦æ³›å‹ï¼ˆä½œä¸ºå‡½æ•°å‚æ•°ï¼‰   | âœ”ï¸ï¼ˆå•æ€åŒ–ï¼‰ | âœ”ï¸ï¼ˆå•æ€åŒ–ï¼‰  | âŒ           |
| æ˜¯å¦æ³›å‹ï¼ˆä½œä¸ºå‡½æ•°è¿”å›å€¼ï¼‰ | âœ”ï¸ï¼ˆå•æ€åŒ–ï¼‰ | âŒ            | âŒ           |







### å‚æ•°å¤šæ€ï¼ˆæ³›å‹ï¼‰

* æ³¨æ„**æ³›å‹**å’Œ**æ³›å‹çº¦æŸ**æ˜¯ä¸ä¸€æ ·çš„ï¼Œå¯ä»¥éšä¾¿ä½¿ç”¨ä¸€ä¸ªç¬¦å·ä»£è¡¨æ³›å‹ï¼Œä½†æ˜¯**æ³›å‹çº¦æŸå¿…é¡»æ˜¯trait**
* traitæ—©æœŸæ„æ€æœ‰ç‚¹æ¨¡ç³Šï¼Œå…·æœ‰traitå’ŒtypeåŒé‡å«ä¹‰ï¼Œå…·ä½“çœ‹[è¿™é‡Œ](https://stackoverflow.com/questions/50650070/what-does-dyn-mean-in-a-type)

ä¾‹å­ï¼š

```rust
fn test<T1>(   //T1æ˜¯ä¸€ä¸ªæ³›å‹å‚æ•°
    a: &dyn T, //trait objectï¼ŒåŠ¨æ€åˆ†æ´¾
    e: impl T, //é™æ€åˆ†æ´¾ï¼Œç¼–è¯‘æ—¶æœ€ç»ˆä¼šæœ‰ç¡®å®šçš„ç±»å‹
    d: T1,     //å³impl T vs æ™®é€šæ³›å‹ï¼Œè§ç¬¬2æ¡å‚è€ƒ
    b: Bar,    //æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªstruct
    c: &Bar,   //æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªstructçš„å¼•ç”¨
) {
}
```



æ³›å‹å•æ€åŒ–çš„ä¼˜ç¼ºç‚¹ï¼š

* ä¼˜ç‚¹ï¼šé«˜æ•ˆï¼Œæ²¡æœ‰è¿è¡Œæ—¶ä»£ä»·
* ç¼ºç‚¹ï¼šç¼–è¯‘é€Ÿåº¦æ…¢ã€ç¼–è¯‘ç»“æœä½“ç§¯å¤§ã€ä»¥äºŒè¿›åˆ¶å‘å¸ƒçš„è¯ä¼šä¸¢å¤±æ³›å‹ä¿¡æ¯



å‚è€ƒï¼š

* https://www.ncameron.org/blog/dyn-trait-and-impl-trait-in-rust/

* https://doc.rust-lang.org/reference/types/impl-trait.html



### adhocå¤šæ€ï¼ˆç‰¹è®¾å¤šæ€ï¼‰

åªæœ‰ä¸€ä¸ªéš¾ç‚¹ï¼Œå³ï¼šæ³›å‹vså…³è”ç±»å‹ï¼Œè¯¦æƒ…è§å‚è€ƒã€‚

>### å…±æ€§
>
>æ³›å‹å’Œå…³è”ç±»å‹æœ€é‡è¦çš„ä¸€ç‚¹æ˜¯éƒ½å…è®¸ä½ å»¶è¿Ÿå†³å®štraitç±»å‹åˆ°å®ç°é˜¶æ®µã€‚å³ä½¿äºŒè€…è¯­æ³•ä¸åŒï¼Œå…³è”ç±»å‹æ€»æ˜¯å¯ä»¥ç”¨æ³›å‹æ¥æ›¿ä»£å®ç°ï¼Œä½†åä¹‹åˆ™ä¸ä¸€å®šã€‚[RFC](https://github.com/rust-lang/rfcs/blob/master/text/0195-associated-items.md)ä¸­æœ‰ä¸ªè¯´æ˜ï¼š"å…³è”ç±»å‹ä¸ä¼šå¢åŠ traitæœ¬èº«çš„è¡¨ç°åŠ›ï¼Œå› ä¸ºä½ æ€»æ˜¯å¯ä»¥å¯¹traitå¢åŠ é¢å¤–çš„ç±»å‹å‚æ•°æ¥è¾¾åˆ°åŒæ ·ç›®çš„"ã€‚ä½†æ˜¯ï¼Œå…³è”ç±»å‹å¯ä»¥æä¾›å…¶ä»–çš„å¥½å¤„ã€‚
>
>æ—¢ç„¶å…³è”ç±»å‹æ€»æ˜¯å¯ä»¥è¢«æ³›å‹æ¥æ›¿ä»£å®ç°ï¼Œé‚£å…³è”ç±»å‹å­˜åœ¨çš„æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ
>
>æˆ‘ä»¬ä¼šè§£é‡Šä¸‹äºŒè€…çš„ä¸åŒï¼Œä»¥åŠæ€ä¹ˆé€‰æ‹©ã€‚
>
>### ä¸åŒä¹‹å¤„
>
>æˆ‘ä»¬å·²ç»çœ‹åˆ°ï¼Œæ³›å‹å’Œå…³è”ç±»å‹åœ¨å¾ˆå¤šä½¿ç”¨åœºåˆæ˜¯é‡å çš„ï¼Œä½†æ˜¯é€‰æ‹©ä½¿ç”¨æ³›å‹è¿˜æ˜¯å…³è”ç±»å‹æ˜¯æœ‰åŸå› çš„ã€‚
>
>æ³›å‹å…è®¸ä½ å®ç°æ•°é‡ä¼—å¤šçš„å…·ä½“traits(é€šè¿‡æ”¹å˜Tæ¥æ”¯æŒä¸åŒç±»å‹)ï¼Œä¾‹å¦‚ä¹‹å‰æåˆ°è¿‡çš„From<T> traitï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä»»æ„æ•°é‡ç±»å‹ã€‚
>
>ä¸¾ä¾‹æ¥çœ‹ï¼Œå‡è®¾ä½ æœ‰ä¸€ä¸ªç±»å‹å®šä¹‰ï¼šMyNumericã€‚ä½ å¯ä»¥åœ¨æ­¤ç±»å‹ä¸Šå®ç° From<u8>, From<u16>, From<u32>ç­‰å¤šç§æ•°æ®è½¬æ¢ã€‚è¿™ä½¿å¾—æ³›å‹åœ¨å¤„ç†ä»…æ˜¯ç±»å‹å‚æ•°ä¸åŒçš„traitæ—¶ç‰¹åˆ«æœ‰ç”¨ã€‚
>
>**å…³è”ç±»å‹**ï¼Œä»å¦ä¸€æ–¹é¢æ¥è¯´ï¼Œä»…å…è®¸ **å•ä¸ªå®ç°**ï¼Œå› ä¸ºä¸€ä¸ªç±»å‹ä»…èƒ½å®ç°ä¸€ä¸ªtraitä¸€æ¬¡ï¼Œè¿™å¯ä»¥ç”¨æ¥é™åˆ¶å®ç°çš„æ•°é‡ã€‚
>
>[Deref trait](https://doc.rust-lang.org/std/ops/trait.Deref.html)æœ‰ä¸€ä¸ªå…³è”ç±»å‹ï¼šTargetï¼Œç”¨äºè§£å¼•ç”¨åˆ°ç›®æ ‡ç±»å‹ã€‚å¦‚æœå¯ä»¥è§£å¼•ç”¨åˆ°å¤šä¸ªä¸åŒç±»å‹ï¼Œä¼šä½¿äººç›¸å½“è¿·æƒ‘ï¼ˆå¯¹ç¼–è¯‘ç±»å‹æ¨å¯¼ä¹Ÿå¾ˆä¸å‹å¥½ï¼‰ã€‚
>
>å› ä¸ºä¸€ä¸ªtraitä»…èƒ½è¢«ç±»å‹å®ç°ä¸€æ¬¡ï¼Œå…³è”ç±»å‹å¸¦æ¥äº†è¡¨è¾¾ä¸Šçš„ä¼˜åŠ¿ã€‚ä½¿ç”¨å…³è”ç±»å‹æ„å‘³ç€ä½ ä¸å¿…å¯¹æ‰€æœ‰é¢å¤–ç±»å‹å¢åŠ ç±»å‹æ ‡æ³¨ï¼Œè¿™å¯ä»¥è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªå·¥ç¨‹ä¼˜åŠ¿ï¼Œå…·ä½“è§ï¼š[RFC](https://github.com/rust-lang/rfcs/blob/master/text/0195-associated-items.md).



å‚è€ƒï¼š

* https://rustcc.cn/article?id=fb4e1512-ca7a-4dfe-9c87-3c98e800ac23



### å­ç±»å‹å¤šæ€

todoï¼švtableçš„è§£æ

å‚è€ƒï¼š

* https://stackoverflow.com/questions/73084234/how-get-pointer-to-virtual-table-from-boxtrait
* [dyn traitçš„å†…å­˜å¸ƒå±€](https://cheats.rs/#pointer-meta)

## æ•°æ®ç»“æ„

[`Borrow<T>`](https://doc.rust-lang.org/std/borrow/trait.Borrow.html#)çš„ä½œç”¨å°±æ˜¯å€Ÿç”¨ï¼Œè¦ç‚¹ï¼š

* å’Œ[`AsRef<T>`](https://doc.rust-lang.org/std/convert/trait.AsRef.html) ä¸€æ ·ï¼Œæœ¬è´¨ä¸Šæ˜¯ä»å°†å½“å‰ç±»å‹å€Ÿç”¨ä¸ºå¦å¤–ä¸€ç§ç±»å‹ï¼Œä½†æœ‰ä¸€äº›å°å·®å¼‚ï¼š

  * `Borrow` **has a blanket impl for any `T`**, and can be used to accept **either a reference or a value**.
  * `Borrow` also requires that [`Hash`](https://doc.rust-lang.org/std/hash/trait.Hash.html), [`Eq`](https://doc.rust-lang.org/std/cmp/trait.Eq.html) and [`Ord`](https://doc.rust-lang.org/std/cmp/trait.Ord.html) for a **borrowed value are equivalent to those of the owned value**. For this reason, if you want to borrow only a single field of a structï¼ˆè¿™é‡Œæ„æ€æ˜¯æŒ‡å°†æ•´ä¸ªstructå€Ÿç”¨ä¸ºå…¶ä¸­æŸä¸ªfieldï¼Ÿï¼‰ you can implement `AsRef`, but not [`Borrow`](https://doc.rust-lang.org/std/borrow/trait.Borrow.html).

* `Borrow`æœ‰è¿™ä¸¤ä¸ªå®ç°ï¼š`impl<T> Borrow<T> for &T`å’Œ`impl<T> Borrow<T> for &T`ï¼Œè¿™ä¼šå¯¼è‡´ä»¥ä¸‹è¯­ä¹‰ï¼š

  ```rust
  fn main() {
      let s = String::from("value");
      let s1: &String = s.borrow();    //impl<T> Borrow<T> for Tçš„åŸå› 
      let s2: &String = (&s).borrow(); //impl<T> Borrow<T> for &Tçš„åŸå› ã€‚è¯­ä¹‰ï¼šå¯¹äºç±»å‹T,å¯ä»¥ä»Tçš„valueæˆ–referenceä¸­å€Ÿç”¨
      let s3: &str = s.borrow();       //impl Borrow<str> for String
      let s4: &str = (&s).borrow();    //å…ˆè½¬ä¸ºs2çš„ç±»å‹&Stringï¼Œç„¶åStringå†derefåˆ°strï¼Œæœ€ç»ˆå¾—åˆ°&str
      let s4 = s.borrow(); //ä¼šæŠ¥é”™ï¼Œå› ä¸ºimpl<T> Borrow<T> for Tå’Œimpl Borrow<str> for Stringå¯¼è‡´æ— æ³•æ¨æ–­å‡ºæœ€ç»ˆç±»å‹
  }
  ```



[ToOwned](https://doc.rust-lang.org/std/borrow/trait.ToOwned.html#)çš„ä½œç”¨å°±å°±æ˜¯å…‹éš†ï¼ˆ**æ³¨æ„ä¸æ˜¯è½¬ç§»æ‰€æœ‰æƒï¼Œåˆ«è¢«åå­—è¯¯å¯¼ï¼**ï¼‰ï¼Œä¸`Clone`ä¸åŒçš„æ˜¯ï¼š

* `Clone`æ˜¯`&T`åˆ°åˆ°`T`
* `ToOwned`æ˜¯ä»`&T`åˆ°`Borrow<T>`ï¼Œå³å…‹éš†ä¹‹åä»¥ä»»æ„ç±»å‹çš„æ–¹å¼è¿”å›å€¼ï¼Œåªè¦è¿™ä¸ªç±»å‹å®ç°äº†`Borrow<Self>`ï¼ˆå³å¯ä»¥ä»ä¸­é‡æ–°å¾—åˆ°`Self`çš„å¼•ç”¨ï¼‰ã€‚
* å› ä¸ºä¸Šé¢çš„åŸå› ï¼Œ**`ToOwned`å¿…å®šå…³è”ä¸€ä¸ª`Borrow<Self>`**



[Cow<'a, B>](https://doc.rust-lang.org/std/borrow/enum.Cow.html#)è¦ç‚¹ï¼š

```rust
pub enum Cow<'a, B>where
    B: 'a + ToOwned + ?Sized,{
    Borrowed(&'a B),
    Owned(<B as ToOwned>::Owned),
}
```

1. **è¯­ä¹‰ï¼šå¯¹æ•°æ®ç±»å‹`B`è¿›è¡Œcopy on write**ï¼Œæ²¡ä¿®æ”¹çš„æ—¶å€™ç”¨`&'a B`ï¼Œä¿®æ”¹åç”¨`<B as ToOwned>::Owned`ã€‚

2. `B`å¿…é¡»æ˜¯`ToOwned`ï¼Œæ„å‘³ç€å®ƒèƒ½å¤Ÿè¢«å…‹éš†

3. æ³¨æ„è¿™æ˜¯ä¸€ä¸ªenumï¼Œ`Borrowed`å’Œ`Owned`**éƒ½æ˜¯è¯¥enumçš„æˆå‘˜ä¸æ˜¯æ•°æ®ç±»å‹**ï¼Œæ‹¬å·é‡Œé¢çš„æ‰æ˜¯å…³è”çš„å…·ä½“ç±»å‹ã€‚





## é”™è¯¯å¤„ç†

è²Œä¼¼æ²¡ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œå…³äºAPIçš„è¯å¯ä»¥å‚è€ƒ[è¿™é‡Œ](./unwrap_expect.md)



## é—­åŒ…

1. é—­åŒ…çš„å¤§å°è·Ÿæ•è·çš„å‚æ•°ç›¸å…³ï¼Œæ˜¯å­˜æ”¾åœ¨æ ˆä¸Šçš„ã€‚æœ‰ä¸€ä¸ªæ²¡è§£å†³çš„é—®é¢˜æ˜¯é—­åŒ…å¯¹åº”å‡½æ•°æ˜¯æ€ä¹ˆè°ƒç”¨çš„ï¼Œåœ¨ç¼–è¯‘é˜¶æ®µå†³å®šï¼Ÿè¿˜æ˜¯é€šè¿‡æŒ‡é’ˆä¼ é€’ï¼Ÿ



# 03 æœŸä¸­æµ‹è¯•

# 04 è¿›é˜¶ç¯‡

# 05 å¹¶å‘ç¯‡

# 06 å®æˆ˜ç¯‡

# 07 é«˜çº§ç¯‡

# 08 å­¦ä¹ é”¦å›Š