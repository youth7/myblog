## 超时重传vs快速重传
tcp作为一种可靠的传输协议，它的可靠性依赖于接收端的ack。tcp在发送数据包的同时，会为被发送的数据包设置一个定时器，如果该数据包的ack在定时器超时之前都没有达到，则会触发发送端的超时重传。在一些tcp的实现中，定时器的间隔不是固定而是采用一种倍增的算法。例如发送某个数据包的时间是t，如果它超时了则重传这个数据包时会将超时时间设为2t，再超时则设为4t。这样的弊端很明显，如果网络环境不好则会使得超时时间越来越长，导致通讯时延增加。

为了应付这种情况，tcp中引入快速重传技术，它无需等待定时器超时就可以断定数据包丢失并重传数据包。快速重传判断数据包丢失的机制是：**发送方收到对同一数据包的3个冗余ack**（关于为何3个冗余ack就可以断定数据丢失的讨论请看[这里](https://www.zhihu.com/question/21789252/answer/110640581)），一言概之，收到冗余ack表示接收端收到乱序数据或者数据真的丢失，**当收到3个冗余ack的时候，表示大概率数据丢失，因此进行快速重传而不是超时重传是有必要的**。在拥塞控制的讨论中我们会看到超时会导致发送端一系列的状态重置（例如窗口大小减半）从而导致传输效率下降，因此又必要减少超时的发生。

超时重传是发送方根据自己设定的定时器来判断的，而快速重传则是根据接收端的反馈来判断的。即使没有快速重传tcp依然可以正确工作，只不过效率会降低，快速重传是提高tcp效率的一种重要手段。

## 流量控制（flow-control service）
流量控制是为了防止发送方发送速率过大，导致接收方缓冲区溢出的一种手段，个人将流量控制看作一种控制双方同步的手段，它通过接收窗口来实现。
* 接收窗口 = 接收方缓冲区的大小 - 已使的缓冲区大小   

![flow-control](/imgs/flow-control.jpg)  
接收方每次ack的时候都将接收窗口捎带上，发送方根据接收窗口的大小来调整自身的发送速度从而实现流量控制。

要注意区分流量控制和拥塞控制，前者只关注发送两端是否同步而不理会通讯链路的情况； 后者是为了防止通讯链路过于拥挤的一种手段，它不理会通讯两端是否同步。


## 拥塞控制（congrestion control）
### 拥塞的控制方法
* 端对端拥塞控制：网络层没有为拥塞控制提供显式的支持，需要端系统自己的观察并推测网络的情况。tcp采用的就是这种方法
* 网络辅助的拥塞控制：  网络层中的单元向发送方提供网络的拥塞情况。
### tcp的拥塞控制
拥塞控制有下面3个部分组成
* 慢启动：使得发送方的拥塞窗口（cwnd）迅速找到一个适当的值，使得发送速率能够迅速提升到适合的速度
* 拥塞避免：当达到一个可能使得网络拥塞的状态后，缓慢增加调整cwnd的值
* 快速恢复：一旦收到3个冗余ack，就进行快速重传，并使cwnd减半。

以上3个部分的状态转换如下所示，从图中看出**超时会导致状态的重置到慢启动，并且窗口立即重设为1**，而碰到3个冗余ack随说没那么苛刻，但是窗口也会迅速减少。

形象地说，tcp是这样一个人：
* 积极：一上来就冲冲冲迅速找到最适合的速度（慢启动时候以指数方式递增cwnd）。
* 谨慎：进入拥塞状态之后谨慎增加窗口大小
* 易受打击：然而一遇到不顺心的事（3个冗余ack）就立即岁头丧气（cwnd减半）
* 决绝：遇到严重的打击（定时器超时）就马上龟缩（cwnd减少到1），没有商量的余地
* 乐观：然而你给他一点鼓励（正常ack）他也能快速振作起来（增加cwnd）

![congrestion-control.jpg](/imgs/congrestion-control.jpg)
